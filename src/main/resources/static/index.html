<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMS - Pro Envanter</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --sidebar-bg: #1e293b; /* Koyu Slate */
            --sidebar-text: #e2e8f0;
            --primary: #4f46e5; /* Ä°ndigo */
            --primary-hover: #4338ca;
            --bg-body: #f1f5f9;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: #334155;
            overflow-x: hidden;
        }

        /* --- LOGIN SCREEN --- */
        #loginOverlay {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #4f46e5 0%, #0f172a 100%);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: white; padding: 3rem; border-radius: 1.5rem;
            width: 100%; max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px; height: 100vh; position: fixed;
            background-color: var(--sidebar-bg); color: var(--sidebar-text);
            padding: 2rem 1.5rem; display: flex; flex-direction: column;
            transition: all 0.3s ease; z-index: 1000;
        }
        .brand {
            font-size: 1.5rem; font-weight: 700; color: white;
            display: flex; align-items: center; gap: 0.75rem; margin-bottom: 3rem;
        }
        .user-profile {
            background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 1rem;
            margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.1);
        }
        .nav-btn {
            background: transparent; border: none; color: #94a3b8;
            width: 100%; text-align: left; padding: 0.75rem 1rem;
            border-radius: 0.5rem; margin-bottom: 0.5rem; font-weight: 500;
            transition: 0.2s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        /* --- MAIN CONTENT --- */
        .main-content { margin-left: 280px; padding: 2.5rem; }
        
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem;
        }

        /* --- CSS: IMPORTANT NOTIFICATIONS --- */
        .important-notifications {
            display: none; /* Otomatik aÃ§Ä±lacak */
            background-color: #fef2f2;
            border: 1px solid #fee2e2;
            border-left: 6px solid #dc2626;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.4s ease-out;
        }
        .notif-header-title {
            color: #b91c1c; font-weight: 700; font-size: 1.1rem;
            display: flex; align-items: center; gap: 10px; margin-bottom: 1rem;
        }
        .notif-list { list-style: none; padding: 0; margin: 0; }
        .notif-item {
            background: white; padding: 12px 15px; margin-bottom: 8px;
            border-radius: 6px; border: 1px solid #fecaca;
            color: #7f1d1d; font-weight: 500; display: flex; align-items: center; gap: 10px;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMPOSITE TREE VIEW (WAREHOUSE STÄ°LÄ°) --- */
        .tree-container { list-style: none; padding: 0; }
        
        .category-block {
            background: white; border-radius: 1rem;
            box-shadow: var(--card-shadow); margin-bottom: 1.5rem;
            overflow: hidden; border: 1px solid #e2e8f0;
        }

        /* Alt kategori (Nested) iÃ§in stil */
        .subcategory-container {
            margin-left: 20px;
            padding-left: 10px;
            border-left: 3px solid #cbd5e1; /* HiyerarÅŸi Ã§izgisi */
        }
        
        .category-header {
            background: #f8fafc; padding: 1rem 1.5rem;
            font-weight: 700; color: #0f172a;
            border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }

        .product-item {
            padding: 1rem 1.5rem; border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
            transition: background 0.2s;
            background: white; /* Alt kategoride arka plan karÄ±ÅŸmasÄ±n */
        }
        .product-item:last-child { border-bottom: none; }
        .product-item:hover { background-color: #f8fafc; }

        .product-info { display: flex; align-items: center; gap: 1rem; }
        .prod-icon {
            width: 40px; height: 40px; background: #e0e7ff; color: var(--primary);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }

        /* --- BUTTONS & BADGES --- */
        .btn-custom-primary {
            background-color: var(--primary); color: white; border: none;
            padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 500;
            transition: 0.2s;
        }
        .btn-custom-primary:hover { background-color: var(--primary-hover); color: white; transform: translateY(-1px); }
        
        .stock-badge {
            font-size: 0.75rem; padding: 0.35em 0.8em; border-radius: 2rem; font-weight: 600;
        }
        .stock-ok { background: #dcfce7; color: #166534; }
        .stock-low { background: #fee2e2; color: #991b1b; }

        .price-tag { font-family: 'Inter', sans-serif; font-weight: 700; color: #334155; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <div class="mb-4">
            <i class="fas fa-cubes fa-3x text-primary"></i>
        </div>
        <h3 class="fw-bold mb-1">IMS GiriÅŸ</h3>
        <p class="text-muted mb-4">Envanter YÃ¶netim Sistemine HoÅŸgeldiniz</p>
        
        <div class="form-floating mb-3">
            <select id="userSelect" class="form-select">
                <option selected disabled>YÃ¼kleniyor...</option>
            </select>
            <label>KullanÄ±cÄ± SeÃ§iniz</label>
        </div>
        <button onclick="login()" class="btn btn-custom-primary w-100 py-3 fs-6">Sisteme GiriÅŸ Yap</button>
    </div>
</div>

<nav class="sidebar" id="sidebar" style="display: none;">
    <div class="brand">
        <i class="fas fa-boxes"></i> Nexus Inventory
    </div>

    <div class="user-profile">
        <div class="d-flex align-items-center gap-3">
            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px;">
                <i class="fas fa-user"></i>
            </div>
            <div style="overflow: hidden;">
                <h6 class="mb-0 text-white text-truncate" id="userNameDisplay">KullanÄ±cÄ±</h6>
                <small class="text-white-50" id="userRoleDisplay">Rol</small>
            </div>
        </div>
    </div>

    <div id="adminControls" style="display: none;">
        <small class="text-uppercase text-white-50 fw-bold mb-2 d-block px-3" style="font-size: 0.75rem;">YÃ¶netim</small>
        <button class="nav-btn" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
            <i class="fas fa-folder-plus me-2"></i> Kategori Ekle
        </button>
        <button class="nav-btn" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <i class="fas fa-box-open me-2"></i> ÃœrÃ¼n Ekle
        </button>
        <button class="nav-btn" data-bs-toggle="modal" data-bs-target="#updateStockModal">
            <i class="fas fa-clipboard-check me-2"></i> Stok SayÄ±mÄ±
        </button>
        <button class="nav-btn mt-2 text-warning" onclick="loadOrderHistory()" data-bs-toggle="modal" data-bs-target="#orderHistoryModal">
            <i class="fas fa-history me-2"></i> Ä°ÅŸlem GeÃ§miÅŸi
        </button>
    </div>

    <div class="mt-auto">
        <button onclick="logout()" class="nav-btn text-danger">
            <i class="fas fa-sign-out-alt me-2"></i> GÃ¼venli Ã‡Ä±kÄ±ÅŸ
        </button>
    </div>
</nav>

<main class="main-content" id="mainContent" style="display: none;">
    <div class="page-header">
        <div>
            <h2 class="fw-bold text-dark mb-1">Envanter Genel BakÄ±ÅŸ</h2>
            <p class="text-muted mb-0">Depo ve stok hiyerarÅŸisi.</p>
        </div>
        <button onclick="loadData()" class="btn btn-white border shadow-sm text-primary fw-bold">
            <i class="fas fa-sync-alt me-2"></i> Verileri Yenile
        </button>
    </div>

    <div id="importantNotificationsPanel" class="important-notifications">
        <div class="notif-header-title">
            <i class="fas fa-triangle-exclamation"></i> Important Notifications
        </div>
        <ul id="criticalStockList" class="notif-list"></ul>
    </div>

    <div id="compositeTreeContainer">
        </div>

</main>

<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">Yeni Kategori</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <label class="small text-muted fw-bold mb-1">Ãœst Kategori (Opsiyonel)</label>
                <select id="parentCatSelect" class="form-select form-select-lg bg-light border-0 mb-3">
                    <option value="">-- Ana Depo (KÃ¶k) --</option>
                </select>

                <label class="small text-muted fw-bold mb-1">Kategori AdÄ±</label>
                <input type="text" id="catNameInput" class="form-control form-control-lg bg-light border-0" placeholder="Ã–rn: Elektronik RafÄ±">
            </div>
            <div class="modal-footer border-0"><button class="btn btn-custom-primary px-4" onclick="addCategory()">OluÅŸtur</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0"><h5 class="modal-title fw-bold">Yeni ÃœrÃ¼n GiriÅŸi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <label class="small text-muted fw-bold mb-1">KATEGORÄ°</label>
                <select id="modalCatSelect" class="form-select form-select-lg bg-light border-0 mb-3"></select>
                
                <label class="small text-muted fw-bold mb-1">ÃœRÃœN BÄ°LGÄ°LERÄ°</label>
                <input type="text" id="prodNameInput" class="form-control mb-2" placeholder="ÃœrÃ¼n AdÄ±">
                <div class="row g-2">
                    <div class="col"><input type="number" id="prodPriceInput" class="form-control" placeholder="Fiyat (TL)"></div>
                    <div class="col"><input type="number" id="prodStockInput" class="form-control" placeholder="Stok Adedi"></div>
                </div>
            </div>
            <div class="modal-footer border-0"><button class="btn btn-custom-primary px-4" onclick="addProduct()">Kaydet</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="updateStockModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0"><h5 class="modal-title">Stok GÃ¼ncelle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="number" id="updateProdId" class="form-control mb-3" placeholder="ÃœrÃ¼n ID">
                <input type="number" id="newStockVal" class="form-control" placeholder="Yeni Stok MiktarÄ±">
            </div>
            <div class="modal-footer border-0"><button class="btn btn-warning text-white fw-bold px-4" onclick="updateStock()">GÃ¼ncelle</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="orderHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 bg-light">
                <h5 class="modal-title fw-bold"><i class="fas fa-history text-primary me-2"></i> Sistem Ä°ÅŸlem GeÃ§miÅŸi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-end mb-3">
                    <button onclick="exportToExcel()" class="btn btn-sm btn-success"><i class="fas fa-file-excel me-2"></i> Excel Olarak Ä°ndir</button>
                </div>
                <table class="table table-hover table-bordered" id="historyTable">
                    <thead class="table-light"><tr><th>ID</th><th>MÃ¼ÅŸteri</th><th>Tutar</th><th>Tarih</th></tr></thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "http://localhost:8081/api";
    let CURRENT_USER = null;

    loadUsers();

    // ðŸ”´ FONKSÄ°YON: Stok Kontrol ve Bildirim OluÅŸturma
    function checkCriticalStock(categories) {
        const notifPanel = document.getElementById("importantNotificationsPanel");
        const notifList = document.getElementById("criticalStockList");
        const isAdmin = CURRENT_USER && (CURRENT_USER.admin || CURRENT_USER.isAdmin);

        if (!isAdmin) { notifPanel.style.display = "none"; return; }

        let alerts = [];

        function traverseAndCheck(items, parentId) {
            items.forEach(item => {
                if (item.price !== undefined) {
                    if (item.stock < 5) {
                        alerts.push(`
                            <li class="notif-item">
                                <i class="fas fa-circle-exclamation text-danger me-2"></i>
                                <span>DÄ°KKAT! Kategori ID: <strong>${parentId}</strong>, ÃœrÃ¼n ID: <strong>${item.id}</strong>, <strong>${item.name}</strong> tÃ¼kenmek Ã¼zere. Acil sipariÅŸ veriniz. (Mevcut: ${item.stock})</span>
                            </li>
                        `);
                    }
                } else if (item.components && item.components.length > 0) {
                    traverseAndCheck(item.components, item.id);
                }
            });
        }

        traverseAndCheck(categories, "KÃ¶k");

        if (alerts.length > 0) {
            notifList.innerHTML = alerts.join("");
            notifPanel.style.display = "block";
        } else {
            notifPanel.style.display = "none";
        }
    }

    // --- RECURSIVE RENDER FUNCTION ---
    function renderComponent(component, isSubCategory = false) {
        let html = "";
        if (component.price !== undefined) {
            html += generateProductRow(component);
        } else {
            const wrapperClass = isSubCategory ? "subcategory-container" : "category-block";
            const icon = isSubCategory ? "fa-folder" : "fa-warehouse";
            
            if(isSubCategory) html += `<div class="${wrapperClass} mt-2">`;
            else html += `<div class="${wrapperClass}">`;

            html += `
                <div class="category-header ${isSubCategory ? 'bg-transparent border-0 ps-0' : ''}">
                    <span><i class="fas ${icon} text-primary me-2"></i> ${component.name}</span>
                    <span class="badge bg-light text-dark border">ID: ${component.id}</span>
                </div>
                <div class="component-list">
            `;

            if (component.components && component.components.length > 0) {
                component.components.forEach(child => {
                    html += renderComponent(child, true);
                });
            } else {
                html += `<div class="p-3 text-muted small fst-italic ms-3">Bu bÃ¶lÃ¼m boÅŸ.</div>`;
            }
            html += `</div></div>`;
        }
        return html;
    }

    // --- SÄ°PARÄ°Åž GEÃ‡MÄ°ÅžÄ° VE EXCEL (YENÄ° EKLENEN KISIM) ---
    async function loadOrderHistory() {
        const tbody = document.getElementById("historyTableBody");
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">YÃ¼kleniyor...</td></tr>';
        try {
            const res = await fetch(`${API_URL}/orders`); 
            const orders = await res.json();
            tbody.innerHTML = "";
            if(orders.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">HenÃ¼z iÅŸlem yok.</td></tr>'; return; }
            orders.reverse().forEach(o => {
                const date = o.orderDate ? new Date(o.orderDate).toLocaleString('tr-TR') : 'Belirsiz';
                const userName = o.user ? o.user.username : 'Bilinmiyor';
                tbody.innerHTML += `<tr><td><small class="text-muted">#${o.id}</small></td><td><i class="fas fa-user-circle text-secondary me-2"></i> ${userName}</td><td class="fw-bold text-success">${o.totalAmount} â‚º</td><td class="small text-muted">${date}</td></tr>`;
            });
        } catch(e) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Veri Ã§ekilemedi.</td></tr>'; }
    }

    function exportToExcel() {
        const table = document.getElementById("historyTable");
        let csvContent = "\uFEFF"; 
        const headers = Array.from(table.querySelectorAll("th")).map(th => th.innerText).join(",");
        csvContent += headers + "\n";
        const rows = table.querySelectorAll("tbody tr");
        rows.forEach(row => {
            const cols = Array.from(row.querySelectorAll("td")).map(td => td.innerText.replace(" â‚º", ""));
            csvContent += cols.join(",") + "\n";
        });
        const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "satis_raporu.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async function loadUsers() {
        try {
            const res = await fetch(`${API_URL}/users`);
            const users = await res.json();
            const select = document.getElementById("userSelect");
            select.innerHTML = '<option disabled selected>LÃ¼tfen seÃ§iniz...</option>';
            users.forEach(u => {
                const isAdmin = u.admin || u.isAdmin;
                select.innerHTML += `<option value='${JSON.stringify(u)}'>${u.username} ${isAdmin ? '(YÃ¶netici)' : ''}</option>`;
            });
        } catch(e) { console.error("API Error"); }
    }

    function login() {
        const select = document.getElementById("userSelect");
        if(!select.value || select.value === "LÃ¼tfen seÃ§iniz...") return alert("KullanÄ±cÄ± seÃ§melisiniz!");
        
        CURRENT_USER = JSON.parse(select.value);
        const isAdmin = CURRENT_USER.admin || CURRENT_USER.isAdmin;

        document.getElementById("loginOverlay").style.display = 'none';
        document.getElementById("sidebar").style.display = 'flex';
        document.getElementById("mainContent").style.display = 'block';

        document.getElementById("userNameDisplay").innerText = CURRENT_USER.username;
        document.getElementById("userRoleDisplay").innerText = isAdmin ? "Sistem YÃ¶neticisi" : "MÃ¼ÅŸteri HesabÄ±";

        document.getElementById("adminControls").style.display = isAdmin ? 'block' : 'none';
        
        loadData();
    }

    function logout() { location.reload(); }

    // ðŸ”´ DÃœZELTME: Ã‡ift GÃ¶sterme Sorunu Ä°Ã§in (Root Only Check)
    async function loadData() {
        const catRes = await fetch(`${API_URL}/categories`);
        const categories = await catRes.json();
        
        checkCriticalStock(categories);

        const parentSelect = document.getElementById("parentCatSelect");
        const prodSelect = document.getElementById("modalCatSelect");
        
        parentSelect.innerHTML = '<option value="">-- Ana Depo (KÃ¶k) --</option>';
        prodSelect.innerHTML = '';

        categories.forEach(c => {
            parentSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            prodSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });

        // ðŸ”´ BURADAKÄ° FÄ°LTRELEME Ã‡Ä°FT GÃ–STERMEYÄ° ENGELLER
        const childIds = new Set();
        categories.forEach(c => {
            if(c.components) {
                c.components.forEach(child => childIds.add(child.id));
            }
        });

        const container = document.getElementById("compositeTreeContainer");
        let html = '<ul class="tree-container">';

        categories.forEach(cat => {
            // Sadece baÅŸkasÄ±nÄ±n Ã§ocuÄŸu OLMAYANLARI Ã§iz
            if (!childIds.has(cat.id)) {
                html += `<li>${renderComponent(cat)}</li>`;
            }
        });
        
        html += `</ul>`;
        container.innerHTML = html;
    }

    function generateProductRow(p) {
        const isAdmin = CURRENT_USER.admin || CURRENT_USER.isAdmin;
        let action = "";

        // Stok Durumu
        let stockClass = p.stock < 5 ? "stock-low" : "stock-ok";
        let stockText = p.stock < 5 ? "Kritik" : "Normal";
        let stockDisplay = `<span class="stock-badge ${stockClass}">Stok: ${p.stock}</span>`;

        if(isAdmin) {
            action = `<span class="text-muted small">YÃ¶netim Modu</span>`;
        } else {
            if(p.stock > 0) {
                const discountPrice = (p.price * 0.9).toFixed(2);
                action = `
                    <div class="btn-group shadow-sm">
                        <button onclick="buy(${p.id}, 'REGULAR')" class="btn btn-outline-primary btn-sm px-3">
                            <span class="d-block small text-muted">Normal</span>
                            <span class="fw-bold">${p.price}â‚º</span>
                        </button>
                        <button onclick="buy(${p.id}, 'DISCOUNT')" class="btn btn-primary btn-sm px-3">
                            <span class="d-block small text-white-50">%10 Ä°ndirim</span>
                            <span class="fw-bold">${discountPrice}â‚º</span>
                        </button>
                    </div>
                `;
            } else {
                action = `<button disabled class="btn btn-secondary btn-sm px-4">TÃ¼kendi</button>`;
            }
        }

        return `
            <div class="product-item">
                <div class="product-info">
                    <div class="prod-icon"><i class="fas fa-cube"></i></div>
                    <div>
                        <h6 class="mb-0 fw-bold text-dark">${p.name}</h6>
                        <small class="text-muted">ID: ${p.id}</small>
                        ${stockDisplay}
                    </div>
                </div>
                <div class="text-end">
                    ${action}
                </div>
            </div>
        `;
    }

    // --- ACTIONS ---
    async function addCategory() {
        const name = document.getElementById("catNameInput").value;
        const parentId = document.getElementById("parentCatSelect").value;
        
        let url = `${API_URL}/categories`;
        
        if(parentId) {
            url = `${API_URL}/categories/${parentId}/subcategories?name=${name}`;
            await fetch(url, {method: 'POST'});
        } else {
            await fetch(url, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name})});
        }
        
        bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide(); 
        loadData();
    }

    async function addProduct() {
        const catId = document.getElementById("modalCatSelect").value;
        const params = new URLSearchParams({
            categoryId: catId, 
            name: document.getElementById("prodNameInput").value, 
            price: document.getElementById("prodPriceInput").value, 
            stock: document.getElementById("prodStockInput").value
        });
        await fetch(`${API_URL}/products?${params}`, {method: 'POST'});
        bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide(); loadData();
    }

    async function updateStock() {
        const id = document.getElementById("updateProdId").value;
        const val = document.getElementById("newStockVal").value;
        await fetch(`${API_URL}/products/${id}/stock?newStock=${val}`, {method: 'PUT'});
        bootstrap.Modal.getInstance(document.getElementById('updateStockModal')).hide(); 
        loadData();
        alert("Stok gÃ¼ncellendi ve Observer tetiklendi.");
    }

    async function buy(id, strategy) {
        if(!confirm("SatÄ±n alma iÅŸlemini onaylÄ±yor musunuz?")) return;
        const res = await fetch(`${API_URL}/orders/checkout`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ userId: CURRENT_USER.id, productIds: [id], strategyType: strategy })
        });
        if(res.ok) {
            const order = await res.json();
            alert(`âœ… SipariÅŸ BaÅŸarÄ±lÄ±! Tutar: ${order.totalAmount} TL`);
            loadData();
        } else alert("Hata oluÅŸtu.");
    }
</script>
</body>
</html>